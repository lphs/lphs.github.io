<!DOCTYPE html>
<html>
<head>
<script>
const days = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"]
var timings;
function load(){
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "https://lphs.github.io/timings.txt", true);
  xhr.onreadystatechange = function() {
    if(xhr.readyState == 4 && xhr.status == 200){
      timings = xhr.responseText;
      update();
    }
  };
  xhr.send(null);
}
function getHour(ampm, hour){
  if(ampm.toLowerCase() == "pm" && Number(hour) != 12){
    return Number(hour)+12;
  }
  return Number(hour);
}
function update(){
  console.log(timings);
  var now = new Date(0, 0, 1, 8, 0, 0); // new Date(0, 0, D(SUN, MUN), H, M, 0)
  var day = days[now.getDay()];
  var timeTableRE = new RegExp("\\|"+day+"\\|.*\n([\\S\\s]*?)\\|.*\\|");
  if(timeTableRE.test(timings)){
  	var timeTable = timings.match(timeTableRE)[1];
    document.getElementById("time").innerText = timeTable;
    var timeRE = /.*?(\d+):(\d+).*?(AM|PM).*?-.*?"(.*)"/g;
    const timeArray = [...timeTable.matchAll(timeRE)];
    console.log(timeArray);
    for(let i = 0; i < timeArray.length; i++){
      var etimeHour = getHour(timeArray[i][3], timeArray[i][1]);
      var etimeMin = Number(timeArray[i][2]);
      var eTime = new Date(0, 0, 0, etimeHour, etimeMin, 0);
      var nTime = new Date(0, 0, 0, now.getHours(), now.getMinutes(), 0);
      if(nTime <= eTime){
        if(i == 0){
          var netimeHour = getHour(timeArray[1][3], timeArray[1][1]);
          var netimeMin = Number(timeArray[1][2]);
          var neTime = new Date(0, 0, 0, netimeHour, netimeMin, 0);
          var timeTo = (neTime-nTime)/(60*1000);
          document.write("Nothing happening yet. "+timeArray[1][4]+" is starting in "+timeTo+" minutes");
          break;
        }
        if(i == timeArray.length){
          document.write("End of school.");
          break;
        }
        var stimeHour = getHour(timeArray[i-1][3], timeArray[i-1][1]);
        var stimeMin = Number(timeArray[i-1][2]);
        var sTime = new Date(0, 0, 0, stimeHour, stimeMin, 0);
        var timeLeft = (eTime-nTime)/(60*1000);
        var periodLength = (eTime-sTime)/(60*1000);
        document.write(timeArray[i-1][4]+" ending in "+timeLeft+" minutes. Period length: "+periodLength+" minutes. You are "+Math.round((periodLength-timeLeft)/periodLength*100)+"% of the way through.");
        break;
      }
    }
  }else{
    document.getElementById("time").innerText = "No timetable for today";
  }
}
</script>
</head>
<body onload="load()">
<span id="time">Loading...</span>  
</body>
</html>
